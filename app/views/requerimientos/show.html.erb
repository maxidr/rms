<% if @requerimiento.errors.any? %>
	<div id="error_explanation">
    <h2>Ocurri처 el siguiente inconveniente:</h2>
    <ul>
    <% @requerimiento.errors.full_messages.each do |msg| %>
      <li><%= msg %></li>
    <% end %>
    </ul>
  </div>
<% end %>

<div id="rqm">

  <h1>Requerimiento N째 <%= @requerimiento.id %></h1>
  <div class="estado <%= @requerimiento.estado.rechazo? ? 'estado_rechazado' : '' %>">
    <%= @requerimiento.estado.to_s %>
    <%- if @requerimiento.estado == Estado::PENDIENTE_RECEPCION %>
      <i>
        <%= " (Fecha probable de entrega: \n #{l @requerimiento.compra.fecha_probable_entrega})" %>
      </i>
    <% end -%>
  </div>
  <div class="rqm-info">
    <div class="left">
      <dl>
        <dt>Solicitante</dt>
        <dd><%= @requerimiento.solicitante %></dd>
      </dl>
      <dl>
        <dt>Fecha de carga</dt>
        <dd><%= l @requerimiento.created_at %></dd>
      </dl>
      <% if @requerimiento.estado.rechazo? %>
        <dl>
          <dt>Motivo del rechazo</dt>
          <dd class="estado_rechazado_title"><%= @requerimiento.motivo_rechazo %></dd>
        </dl>
      <% end %>
    </div>
    <div class="right">
      <dl>
        <dt>Empresa</dt>
        <dd><%= @requerimiento.empresa %></dd>
      </dl>
      <dl>
        <dt>Sector</dt>
        <dd><%= @requerimiento.sector %></dd>
      </dl>
      <dl>
        <dt>Rubro</dt>
        <dd><%= @requerimiento.rubro %></dd>
      </dl>
      <dl>
        <dt>Consumo</dt>
        <dd><%= @requerimiento.consumo %></dd>
      </dl>
    </div>
  </div>
  
  <%= render "materiales.html.erb" %>

  <% if (@requerimiento.estado >= Estado::APROBADO_X_COMPRAS && @requerimiento.estado != Estado::RECHAZO_X_COMPRAS) || (@requerimiento.estado == Estado::PENDIENTE_APROBACION_COMPRAS && @requerimiento.presupuestos.seleccionado) %>
	  <%= render "presupuestos/aprobado.html.erb", :presupuesto => @requerimiento.presupuestos.aprobado ? @requerimiento.presupuestos.aprobado : @requerimiento.presupuestos.seleccionado %>
  <% else %>
	  <%= render "presupuestos/list.html.erb", :presupuestos => @requerimiento.presupuestos %>
  <% end %>


  <% if can? :aprobar_presupuestos, @requerimiento %>
    <% unless @requerimiento.presupuestos.seleccionado %>
      <p>
        <b>Aprobar presupuesto:</b>
        Para aprobar el requerimiento debe seleccionar un presupuesto y aprobarlo
      </p>
    <% end %>

   <% end %>

  <div id="rqm_actions">
	  <% if can? :solicitar_aprobacion, @requerimiento %>
		  <%= link_to 'Solicitar aprobaci처n', solicitar_aprobacion_requerimiento_path(@requerimiento), :method => :put %>
	  <% end %>

	  <% if can? :aprobar_por_sector, @requerimiento %>
		  <%= link_to 'Aprobar', aprobar_requerimiento_path(@requerimiento), :method => :put %>
		  <%= link_to 'Rechazar', rechazar_requerimiento_path(@requerimiento), :class => 'negative_action', :remote => true %>
	  <% end %>

	  <% if can? :solicitar_aprobacion_compras, @requerimiento %>
		  <%= link_to 'Solicitar aprobaci처n de compras', aprobacion_compras_requerimiento_path(@requerimiento), :method => :put  %>
	  <% end %>

	  <% if can? :aprobar_presupuestos, @requerimiento %>
		  <%= link_to 'Rechazar presupuestos', rechazar_presupuestos_requerimiento_path(@requerimiento) , :class => 'negative_action reject', :remote => true %>
    <% end %>

    <% if can? :aprobar_presupuesto_seleccionado, @requerimiento %>
      <%= link_to 'Aprobar presupuesto', aprobar_presupuesto_path(@requerimiento.presupuestos.seleccionado), :method => :put %>
    <% end %>

	  <% if can? :recepcionar, @requerimiento %>
		  <%= link_to 'Recepcionar materiales', recepcionar_requerimiento_path(@requerimiento), :method => :put %>
	  <% end %>

	  <% if can? :verificar_entrega, @requerimiento %>
		  <%= link_to 'Entrega correcta', verificar_entrega_requerimiento_path(@requerimiento), :method => :put %>
		  <%= link_to 'Rechazar entrega', rechazar_entrega_requerimiento_path(@requerimiento), :class => 'negative_action' %>
	  <% end %>

	  <% if can? :finalizar, @requerimiento %>
		  <%= link_to 'Finalizar requerimiento', finalizar_requerimiento_path(@requerimiento), :method => :put  %>
	  <% end %>

    <% if can? :comprar, @requerimiento %>
	    <%= render "comprar" %>
    <% end %>

    <% if can? :generar_reporte, @requerimiento %>
      <%= link_to "Generar reporte", requerimiento_path(@reporte, :format => :pdf) %>
    <% end %>



    <% if can? :edit, @requerimiento %>
  	  <%= link_to 'Editar', edit_requerimiento_path(@requerimiento), :class => 'edit' %>
    <% end %>
  </div>

  <%= link_to 'Volver', requerimientos_path, :class => 'back_button' %>
  <br/>
</div>

